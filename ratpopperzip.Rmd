```{r}
#Mariana Vazquez
#June 24th 2022

#install.packages("shiny")
library(shiny)
install.packages("leaflet")
install.packages("sf")
library(sf)
library(leaflet)

install.packages("tigris")
library(tigris)
library("tidyverse")

#modzcta shapefiles from NYC open data
unzip("Modified Zip Code Tabulation Areas (MODZCTA).zip")
modzcta <- st_read("geo_export_9d592ba8-7629-4558-9e78-e1e536b453d9.shp")
head(modzcta)

#importing dataset
df1 <- read.csv("https://raw.githubusercontent.com/marmar897/RatsData/chris-branch/DataSets/dfNYC.csv")

ziplots <- df1 %>%
          group_by(Zip) %>%
          summarise(totallots = n())

#merge(ziplots, df1, by = "Zip")

#the number of lots that had reports in both years *50 in zipcode.
  #grouping by zip and bbl to get number of reported calls in years 2020 and 2021

df2 <- df1 %>%
      group_by(Zip,BBL) %>%
      summarize(reports2020 = (sum(Year==20)),
                reports2021 = (sum(Year==21)), 
                both = (reports2020 > 0 & reports2021 > 0)
                #totalbbls = n(BBL)
                )



# grouping by zip to count total lots in each zipcode and capture recapture for each lot
df3 <- df2 %>% 
      #full_join(y = ziplots, by = c("totallots"))%>%
      #cbind(df2, )
      group_by(Zip) %>%
     # ziplots$totallots <- totallots %>%
      #full_join(y = ziplots, by = "Zip") %>%
      #geo_join( ziplots, "totallots", "zip", how = "inner")
      summarize(markedlotstotal2020 = sum(reports2020 > 0), 
                markedlotstotal2021 = sum(reports2021 > 0), 
                both = (markedlotstotal2020+markedlotstotal2021),
                totallots = n(),
                estpopulation = ifelse(markedlotstotal2021 == 0 | both == 0,
                                      totallots*50,
                                       50*totallots*markedlotstotal2021/both)) %>% 
               #estpopulation = 50*totallots*markedlotstotal2021/both
      mutate(zip = as.character(Zip))

#testing my sum below outputs around 1.9 million rats
sum(df3$estpopulation)

#joining dataset with modzcta by zipcodes
all_modzcta <- geo_join(modzcta, df3, "modzcta", "zip", how = "inner")

#labels when you hover over a zip block

labels <-sprintf(
  "<strong>%s</strong><br/>%g%%",
  all_modzcta$modzcta,all_modzcta$estpopulation) %>%
  lapply(htmltools::HTML)
pal <-colorBin(palette="Reds", 9, domain = all_modzcta$estpopulation)
#OrRd

#building interactive map
map_interactive <-all_modzcta %>%
  st_transform(crs = "+init=epsg:4326") %>% #transform data into coordinate system
  leaflet() %>%
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(label = labels,
              stroke = FALSE,
              smoothFactor = 0.5,
              opacity = 1,
              fillOpacity = 0.7,
              fillColor = ~pal(estpopulation),
              highlightOptions = highlightOptions(
                    weight = 5,
                    color = "black",
                    fillOpacity = 1,
                    opacity = 1,
                    bringToFront = TRUE))%>%
  addLegend("topleft",
          pal = pal,
          values = ~estpopulation,
          title = "Estimated number of rat population by zipcodes 2020-2021",
          opacity = 0.7)
#displaying map :)
map_interactive
#saveWidget(map_interactive, "nyc_average_rats.html")
```
