```{r}
#Mariana Vazquez
#June 24th 2022

#install.packages("shiny")
library(shiny)
install.packages("leaflet")
install.packages("sf")
library(sf)
library(leaflet)

install.packages("tigris")
library(tigris)
library("tidyverse")

#modzcta shapefiles from NYC open data
unzip("Modified Zip Code Tabulation Areas (MODZCTA).zip")
modzcta <- st_read("geo_export_9d592ba8-7629-4558-9e78-e1e536b453d9.shp")
head(modzcta)

#importing dataset
df1 <- read.csv("https://raw.githubusercontent.com/marmar897/RatsData/chris-branch/DataSets/df_NYC.csv")

# ziplots <- df1 %>%
#           group_by(Zip) %>%
#           summarise(totallots = n())



#the number of lots that had reports in both years *50 in zipcode.
  #grouping by zip and bbl to get number of reported calls in years 2020 and 2021

df2 <- df1 %>%
      group_by(Zip,BBL) %>%
      summarize(reports2020 = (sum(Year==20)),
                reports2021 = (sum(Year==21)), 
                both = (reports2020 > 0 & reports2021 > 0)
                )

# grouping by zip to count total lots in each zipcode and capture recapture for each lot
df3 <- df2 %>% 

      group_by(Zip) %>%

      summarize(markedlotstotal2020 = sum(reports2020 > 0), 
                markedlotstotal2021 = sum(reports2021 > 0),
                
                #number of identical lots in both years 
                #figure out rat sightings in identical lots in both years
                both = (sum(both > 0)),

                estpopulation = ifelse( both == 0, 0, 50*markedlotstotal2020*markedlotstotal2021/both)) %>%
                
              #  ifelse( both > 0 & markedlotstotal2021 > 0 & markedlotstotal2020 > 0,       #50*markedlotstotal2020*markedlotstotal2021/both,
              #  ifelse(both == 0 & markedlotstotal2021 >0 & markedlotstotal2020 >0,  50*markedlotstotal2020*markedlotstotal2021,
               # ifelse(markedlotstotal2020 == 0,  50*markedlotstotal2021,
              #  ifelse(markedlotstotal2021 == 0,  50*markedlotstotal2020))))) %>% 
      mutate(zip = as.character(Zip))


# # Function to estimate number of rats in any year (%y between 11 and 21) 
# capture_recapture <- function(year) {
#   lots_year_1 <- df %>% filter(Year == year - 1) %>% pull(BBL)
#   lots_year_2 <- df %>% filter(Year == year) %>% pull(BBL)
#   number_in_year_1 <- length(lots_year_1)
#   number_in_year_2 <- length(lots_year_2)
#   number_in_year_1_and_2 <- sum(lots_year_1 %in% lots_year_2)
#   50 * number_in_year_1 * number_in_year_2 / number_in_year_1_and_2
# }
# 
# 
# 



#testing my sum below outputs around 3.4 million rats
sum(df3$estpopulation)

#joining dataset with modzcta by zipcodes
all_modzcta <- geo_join(modzcta, df3, "modzcta", "zip", how = "inner")

#labels when you hover over a zip block

labels <-sprintf(
  "<strong>%s</strong><br/>%g%%",
  all_modzcta$modzcta,all_modzcta$estpopulation) %>%
  lapply(htmltools::HTML)
pal <-colorBin(palette="Reds", 9, domain = all_modzcta$estpopulation)
#OrRd

#building interactive map
map_interactive <-all_modzcta %>%
  st_transform(crs = "+init=epsg:4326") %>% #transform data into coordinate system
  leaflet() %>%
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(label = labels,
              stroke = FALSE,
              smoothFactor = 0.5,
              opacity = 1,
              fillOpacity = 0.7,
              fillColor = ~pal(estpopulation),
              highlightOptions = highlightOptions(
                    weight = 5,
                    color = "black",
                    fillOpacity = 1,
                    opacity = 1,
                    bringToFront = TRUE))%>%
  addLegend("topleft",
          pal = pal,
          values = ~estpopulation,
          title = "Estimated number of rat population by zipcodes 2020-2021",
          opacity = 0.7)
#displaying map :)
map_interactive

```
