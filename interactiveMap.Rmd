```{r}
#install.packages("shiny")
library(shiny)
install.packages("leaflet")
install.packages("sf")
library(sf)
library(leaflet)

install.packages("tigris")
library(tigris)
library("tidyverse")

#modzcta shapefiles from NYC open data
unzip("Modified Zip Code Tabulation Areas (MODZCTA).zip")
modzcta <- st_read("geo_export_9d592ba8-7629-4558-9e78-e1e536b453d9.shp")
head(modzcta)

#
df1 <- read.csv("rats_cleaned.csv")

#total <- sum(df1$count)

#df2 <-
  # df1 %>% 
  #filter(Year == 2020 & 2019)
    #group_by(zip)
#newTotal <-sum(df2$count)


# creating 2021 and 2020 dataframes
zips_year_1 <- df1 %>% filter(Year == 2020) 
zips_year_2 <- df1 %>% filter(Year == 2021)

# estimate number of rats in each zipcode
#capture_recapture function with zipcode filter and addition year 2019-2020 dataset
#
count_per_zip <- function(zipcode){
  lots_y2020 <- zips_year_1 %>% filter(zip == zipcode)  %>%pull(BBL)
  lots_y2021 <- zips_year_2 %>% filter (zip == zipcode) %>%pull(BBL)
  number_in_year_1 <- length(lots_y2020)
  #print(number_in_year_1)
  number_in_year_2 <- length(lots_y2021)
  #print(number_in_year_2)
  number_in_year_1_and_2 <- sum(lots_y2021 %in% lots_y2020)
  #sum(lots_year_1 %in% lots_year_2)
  #print(number_in_year_2)
  50 * number_in_year_1 * number_in_year_2 / number_in_year_1_and_2
}

# testing function count_per_zip(10003)



#data processing
df <- df1 %>%
      group_by(zip) %>%
      summarize(population = (count_per_zip(zip))) 
df$zip<-as.character(df$zip)
head(df)



all_modzcta <- geo_join(modzcta, df, "modzcta", "zip", how = "inner")

#head(all_modzcta)
#saveRDS(all_modzcta, "all_modzcta.RDS")
#labels when you hover over a zip block

labels <-sprintf(
  "<strong>%s</strong><br/>%g%% ",
  all_modzcta$modzcta,all_modzcta$population) %>%
  lapply(htmltools::HTML)
pal <-colorBin(palette="Reds", 9, domain = all_modzcta$population)
#OrRd
#build interactive map
map_interactive <-all_modzcta %>%
  st_transform(crs = "+init=epsg:4326") %>% #transform data into coordinate system
  leaflet() %>%
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(label = labels,
              stroke = FALSE,
              smoothFactor = 0.5,
              opacity = 1,
              fillOpacity = 0.7,
              fillColor = ~pal(population),
              highlightOptions = highlightOptions(
                    weight = 5,
                    color = "black",
                    fillOpacity = 1,
                    opacity = 1,
                    bringToFront = TRUE))%>%
  addLegend("topleft",
          pal = pal,
          values = ~population,
          title = "Estimated number of rat population by zipcodes 2020-2021",
          opacity = 0.7)
map_interactive
#saveWidget(map_interactive, "nyc_average_rats.html")
```
